library(shiny)
library(readr)
library(ggplot2)
library(dplyr)
library(DT)

data.all <- read_csv("https://www.stat2games.sites.grinnell.edu/data/greenhouse/getdata.php") 
data.all <- select(data.all, GroupID, PlayerID, Level, Season, SellPrice, BuyPrice, Crop, Money, Water, Nitrates, Yield, Profit)

#Revenue/Costs/Profit
data.all <- data.all %>% mutate(Revenue = Money,
                                Costs = BuyPrice + Water + (Nitrates - 250)/10,
                                Profit = Revenue - Costs)

data.all$Level <- as.factor(data.all$Level)
data.all$GroupID <- tolower(data.all$GroupID)
data.all$GroupID <- as.character(data.all$GroupID)
data.all$PlayerID <- as.character(data.all$PlayerID)

all_groups <- sort(unique(data.all$GroupID))
all_players <- sort(unique(data.all$PlayerID))

# UI
ui <- fluidPage(
  
  titlePanel("Greenhouse RTutorial"),
  
  sidebarLayout(
    sidebarPanel(
      
      selectInput(inputId = "groupID",
                  label = "Group ID:", 
                  choices =  c("all", all_groups),
                  multiple = TRUE,
                  selectize = TRUE,
                  selected = "all"),
      
      selectInput(inputId = "xvar",
                  label = "X Variable:",
                  choices = c("Water", "Nitrates"),
                  selected = "Water",
                  multiple = FALSE),
      
      
      selectInput(inputId = "yvar",
                  label = "Y Variable:",
                  choices = c("Yield", "Revenue", "Costs", "Profit"),
                  selected = "Yield",
                  multiple = FALSE),
      
      selectInput(inputId = "color",
                  label = "Color by",
                  choices = c("Crop", "Season", "Plot", "PlayerID", "Water", "Nitrates"),
                  selected = "Nitrates",
                  multiple = FALSE),
      
      selectInput(inputId = "facet",
                  label = "Facet by:",
                  choices = c("Level", "Season", "Crop"),
                  selected = "Level",
                  multiple = FALSE),

      checkboxInput('bplot',"Add model", FALSE),
      
      
      downloadButton('downloadData', label = "Greenhouse Data"),
      
    ),
    
    mainPanel(
      tabsetPanel(
        type = "tabs",
        # First tab
        tabPanel("Data Wrangling",
                 verbatimTextOutput("filterCode"),
                 DTOutput("dataPreview")), 
        #Second tab
        tabPanel("Data Visualizations", 
                 plotOutput(outputId = "Plot")),  
      )
    )
  )
  
)

# Server
server <- function(input, output, session) {
  # Reactive expression to generate and store the filter code
  filterCode <- reactive({
    req(input$groupID)  # Ensure Group ID input is available
    
    # Start building the R code for filtering
    code <- "data <- readr::read_csv('https://www.stat2games.sites.grinnell.edu/data/greenhouse/getdata.php')"  # Start with the original dataset
    
    # Filter by Group ID
    if (length(input$groupID) > 0) {
      code <- paste(code, sprintf("\ndata <- data[data$GroupID %%in%% c('%s'), ]", paste(input$groupID, collapse = "', '")), sep="")
    }
    
    # Code to select specific columns based on X and Y variables
    selected_columns <- unique(c("GroupID", "PlayerID", input$xvar, input$yvar, input$color, if(input$facet != "None") input$facet))
    select_code <- paste("c('", paste(selected_columns, collapse = "', '"), "')", sep="")
    code <- paste(code, sprintf("\ndata <- data[, %s, drop = FALSE]", select_code), sep="")
    
    code
  })
  
  # Output the filter code to the UI
  output$filterCode <- renderText({
    req(filterCode())
    filterCode()  # Display the dynamically generated R code for filtering
  })
  
  # Reactive expression to store filtered data
  filteredData <- reactive({
    req(data.all)  # Ensure the dataset is loaded
    
    # Filter by Group ID
    if (length(input$groupID) > 0) {
      if ("all" %in% input$groupID) {
        data <- data.all
      }
      else{
        data <- data.all[data.all$GroupID %in% input$groupID, ]
      }
    } else {
      data <- data.all  # No filtering if no group selected
    }
    
    # Dynamically select columns based on user input for X and Y variables
    selected_columns <- unique(c("GroupID", "PlayerID", input$xvar, input$yvar, input$color, "Level", if(input$facet != "None") input$facet))
    data <- data[, selected_columns, drop = FALSE]
    
    data
  })
  
  
  # Display the first 10 rows of the filtered data
  output$dataPreview <- renderDT({
    req(filteredData())
    datatable(filteredData(), options = list(pageLength = 10))
  })
  
  
  # Download filtered data
  output$downloadData <- downloadHandler(
    filename = function() {
      paste('Data-', Sys.Date(), '.csv', sep="")
    },
    content = function(con) {
      write.csv(filteredData(), con)
    }
  )
  
  # Generate plot based on the filtered data
  output$Plot <- renderPlot({
    plotData <- filteredData()
    
    if (input$bplot == "TRUE"){
      myplot <- ggplot(data = plotData, aes_string(x = input$xvar, y = input$yvar, color=input$color)) +
        geom_smooth(se=FALSE) +
        geom_point(position=position_dodge(0.8)) +
        xlab(input$xvar) + ylab(input$yvar)
    } else {
      myplot <- ggplot(data = plotData, aes_string(x = input$xvar, y = input$yvar, color=input$color)) +
        geom_point(position=position_dodge(0.8)) +
        xlab(input$xvar) + ylab(input$yvar)
    }
    
    if (input$facet != "None") {
      myplot <- myplot + facet_wrap(as.formula(paste("~", input$facet))) +
        labs(title = paste("Plot of ",input$yvar, "by",input$xvar, "and Faceted by type of", input$facet))
    }
    
    myplot
  })
}


#Running Shiny App
shinyApp(ui = ui, server = server)
